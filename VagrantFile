# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "bento/debian-11"
  config.ssh.insert_key= false


  config.vm.define "flask" do |debian|
     debian.vm.hostname="debian"
     debian.vm.network "private_network",ip: "192.168.56.20"
     debian.vm.provision "shell",path: "flask.sh"
     debian.vm.provision "shell",privileged: false,inline: <<-SHELL
     export PATH="$PATH:/home/vagrant/.local/bin"
     export PIPENV_VENV_IN_PROJECT=1
     pip3 install pipenv python-dotenv
     
     pipenv --version

     cd /var/www/app

     echo "FLASK_APP=wsgi.py" > .env
     echo "FLASK_ENV=production" >> .env

     pipenv install flask gunicorn

     cp /vagrant/application.py ./
     cp /vagrant/wsgi.py ./

     cd /var/www
     git clone https://github.com/Azure-Samples/msdocs-python-flask-webapp-quickstart app_azure
     cd app_azure

     export PIPENV_VENV_IN_PROJECT=1
     pipenv install -r requirements.txt

     # COMANDO PARQA QUE CORRA DIRECTAMENTE pipenv run flask run --host '0.0.0.0' &
     # COMANDO PARA QUE SE EJECUTE CON GUNICORN pipenv run gunicorn --workers 4 --bind 0.0.0.0:5000 wsgi:app --daemon
    sudo systemctl daemon-reload
    sudo systemctl restart flask_app
    sudo systemctl restart flask_azure
    sudo systemctl restart nginx

     SHELL
  end
end